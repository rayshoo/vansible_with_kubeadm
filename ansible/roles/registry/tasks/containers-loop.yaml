---
- set_fact:
    count: "{{ count | int + 1 }}"

- when: item['location'] == groups['ansible_master'][0] + ':5000'
  block:
  - set_fact:
      already_exists: true

  - when: not item['insecure']
    block:
    - name: get registries config
      shell: cat /etc/containers/registries.conf | yj -tji | jq -r '.registry[{{ count }}].insecure = true' | yj -jt
      register: registries_config
      changed_when: false
    - name: comment original config
      replace:
        dest: /etc/containers/registries.conf
        regexp: (^[^#].*)
        replace: '#\1'
        backup: yes
      notify: restart podman.socket
    - name: change insecure enable
      blockinfile:
        dest: /etc/containers/registries.conf
        block: "{{ registries_config['stdout'] }}"
        backup: yes
        insertbefore: BOF
      notify: restart podman.socket